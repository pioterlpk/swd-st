<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>SWD-ST PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root{
--bg:#0c0f14;--panel:#141925;--panel2:#1b2233;
--accent:#ff2a2a;--text:#e8eaf0;--muted:#8c93a8;
}
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:var(--bg);color:var(--text)}
header{height:56px;background:#0f131c;display:flex;align-items:center;justify-content:space-between;padding:0 20px}
button{cursor:pointer}

#app{display:grid;grid-template-columns:360px 1fr;height:calc(100vh - 56px)}
#left{background:var(--panel);overflow:auto}
.panelHeader{padding:12px;font-weight:700;border-bottom:1px solid #222}
.card{padding:12px;border-bottom:1px solid #222}
.card:hover{background:#ffffff08}

.badge{padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600}
.WOLNY{background:#2ecc71;color:#000}
.W_DRODZE{background:#3498db}
.NA_MIEJSCU{background:#e74c3c}

#map{height:100%}

.modal{
position:fixed;inset:0;background:rgba(0,0,0,.7);
display:flex;align-items:center;justify-content:center;z-index:999
}
.modalBox{
background:var(--panel);padding:20px;border-radius:14px;width:360px
}
.modalBox input,.modalBox select,.modalBox button{
width:100%;padding:10px;margin-bottom:10px;
background:var(--panel2);border:none;border-radius:10px;color:#fff
}
</style>
</head>

<body>

<header>
<strong>üöí SWD-ST PRO</strong>
<nav>
<button onclick="openStationModal()">+ Remiza</button>
<button onclick="openEventModal()">+ Zdarzenie</button>
</nav>
</header>

<div id="app">
<div id="left">
<div class="panelHeader">Zdarzenia</div>
<div id="events"></div>
<div class="panelHeader">Remizy</div>
<div id="stations"></div>
</div>
<div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;
let events=[], stations=[];
let movingVehicles=[];

map=L.map("map").setView([51.9,21.6],10);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* ===== MODAL ===== */
function modal(html){
 const m=document.createElement("div");
 m.className="modal";
 m.innerHTML=`<div class="modalBox">${html}<button onclick="closeModal()">Zamknij</button></div>`;
 document.body.appendChild(m);
}
function closeModal(){document.querySelectorAll(".modal").forEach(m=>m.remove())}

/* ===== REMIZY ===== */
function openStationModal(){
 modal(`
 <h3>Nowa remiza</h3>
 <input id="sName" placeholder="Nazwa remizy">
 <button onclick="addStation()">Dodaj</button>
 `);
}
function addStation(){
 stations.push({
  name:sName.value,
  pos:map.getCenter(),
  firefighters:[],
  vehicles:[]
 });
 closeModal();render();
}
function manageStation(i){
 const s=stations[i];
 modal(`
 <h3>${s.name}</h3>
 <input id="ff" placeholder="Stra≈ºak">
 <button onclick="s.firefighters.push(ff.value);manageStation(${i})">+ Stra≈ºak</button>
 <input id="vh" placeholder="W√≥z">
 <button onclick="s.vehicles.push({name:vh.value,status:'WOLNY'});manageStation(${i})">+ W√≥z</button>
 <p>üë®‚Äçüöí ${s.firefighters.join(", ") || "-"}</p>
 <p>üöí ${s.vehicles.map(v=>v.name).join(", ") || "-"}</p>
 `);
}

/* ===== ZDARZENIA ===== */
function openEventModal(){
 modal(`
 <h3>Nowe zdarzenie</h3>
 <input id="eTitle" placeholder="Opis zdarzenia">
 <button onclick="addEvent()">Dodaj</button>
 `);
}
function addEvent(){
 const pos=map.getCenter();
 events.push({title:eTitle.value,pos});
 L.marker(pos).addTo(map);
 closeModal();render();
}

/* ===== DYSPOZYCJA ===== */
function dispatchEvent(ei){
 modal(`
 <h3>Wy≈õlij jednostkƒô</h3>
 <select id="sSel">${stations.map((s,i)=>`<option value="${i}">${s.name}</option>`).join("")}</select>
 <select id="vSel"></select>
 <button onclick="sendUnit(${ei})">WY≈öLIJ</button>
 `);
 updateVehicleList();
 sSel.onchange=updateVehicleList;
}
function updateVehicleList(){
 const s=stations[sSel.value];
 vSel.innerHTML=s.vehicles.map((v,i)=>`<option value="${i}">${v.name}</option>`).join("");
}

function sendUnit(ei){
 const s=stations[sSel.value];
 const v=s.vehicles[vSel.value];
 v.status="W_DRODZE";
 animateVehicle(s.pos,events[ei].pos,v);
 closeModal();render();
}

/* ===== TRASA + ANIMACJA (OSRM) ===== */
async function animateVehicle(start,end,vehicle){
 const url=`https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;
 const res=await fetch(url);
 const data=await res.json();
 const coords=data.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);

 const marker=L.marker(coords[0],{icon:L.divIcon({html:"üöí",iconSize:[24,24]})}).addTo(map);
 let i=0;
 const int=setInterval(()=>{
  i++;
  if(i>=coords.length){
   clearInterval(int);
   vehicle.status="NA_MIEJSCU";
   render();
   return;
  }
  marker.setLatLng(coords[i]);
 },200);
}

/* ===== RENDER ===== */
function render(){
 eventsDiv.innerHTML="";
 events.forEach((e,i)=>{
  eventsDiv.innerHTML+=`
  <div class="card">
   <b>${e.title}</b><br>
   <button onclick="dispatchEvent(${i})">Wy≈õlij jednostkƒô</button>
  </div>`;
 });
 stationsDiv.innerHTML="";
 stations.forEach((s,i)=>{
  stationsDiv.innerHTML+=`
  <div class="card" onclick="manageStation(${i})">
   <b>${s.name}</b><br>
   üë®‚Äçüöí ${s.firefighters.length} | üöí ${s.vehicles.length}
  </div>`;
 });
}
</script>

</body>
</html>
